####### Webmin #######

Instalamos el setup

curl -o webmin-setup-repo.sh https://raw.githubusercontent.com/webmin/webmin/master/webmin-setup-repo.sh
sudo sh webmin-setup-repo.sh

Instalamos Webmin

sudo apt-get install webmin --install-recommends

Acceso por web

127.0.0.1:10000

(usuarios y contraseñas del usuario regular)


(Administración de usuarios: Crear, y eliminar una cuenta de usuario.

System > Users and Groups > Create New User

Gestión de servicios: Iniciar, detener y reiniciar servicio del sistema (Ej SSH). 

System > Bootup and Shutdown

Configuración de red: Configurar una IP estatica en interfaces de red.

Networking > Network Configuration > Network Interfaces 

Administración de software: actualizar  Instalar,y eliminar Alguna herramienta.

System > Software Packages

Gestión de archivos y directorios: Explorar, editar un archivo y eliminarlo. 

Tools > File Manager

Monitorización del sistema: Supervisar el rendimiento del sistema,(Memoria, Procesador Armacenamiento).

Dashboard


######################



####### Terraform #######

#Setup Terraform#

#Instalar Terraform

sudo apt-get update && sudo apt-get install -y gnupg software-properties-common

wget -O- https://apt.releases.hashicorp.com/gpg | \
gpg --dearmor | \
sudo tee /usr/share/keyrings/hashicorp-archive-keyring.gpg > /dev/null

gpg --no-default-keyring \
--keyring /usr/share/keyrings/hashicorp-archive-keyring.gpg \
--fingerprint

echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(grep -oP '(?<=UBUNTU_CODENAME=).*' /etc/os-release || lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list

sudo apt update
sudo apt-get install terraform

#Verificamos Instalacion

terraform -help

#Setup Azure#

#Instalar Azure CLI

curl -L https://aka.ms/InstallAzureCli | bash

#Logeamos con Azure

az login --use-device-code

az account show --output table

az account set --subscription "(ID)"

#Creamos el servicio principal

az ad sp create-for-rbac --role="Contributor" --scopes="/subscriptions/<SUBSCRIPTION_ID>"

#Exportamos las variables de entorno

export ARM_CLIENT_ID="<APPID_VALUE>"
export ARM_CLIENT_SECRET="<PASSWORD_VALUE>"
export ARM_SUBSCRIPTION_ID="<SUBSCRIPTION_ID>"
export ARM_TENANT_ID="<TENANT_VALUE>"

Generamos claves ssh

ssh-keygen -t rsa -b 4096 -f ~/.ssh/azure_vm_key

Creamos un directorio para el terraform

mkdir Terraform_Azure
cd Terraform_Azure

Creamos el main.tf y agregamos el codigo de infraestructura:
nano main.tf

main.tf

terraform {
  required_providers {
    azurerm = {
      source  = "hashicorp/azurerm"
      version = "~> 3.110.0"   # última estable
    }
  }

  required_version = ">= 1.1.0"
}

provider "azurerm" {
  features {
    resource_group {
      prevent_deletion_if_contains_resources = false
    }
  }
}

# Grupo de recursos
resource "azurerm_resource_group" "rg" {
  name     = "TerraFormSOIIIRG"
  location = "canadacentral"
}

# Red virtual
resource "azurerm_virtual_network" "vnet" {
  name                = "TFSOIIIVnet"
  address_space       = ["10.0.0.0/16"]
  location            = azurerm_resource_group.rg.location
  resource_group_name = azurerm_resource_group.rg.name
}

# Subnet (con dependencia explícita de la VNet)
resource "azurerm_subnet" "subnet" {
  name                 = "TFSOIIISubnet"
  resource_group_name  = azurerm_resource_group.rg.name
  virtual_network_name = azurerm_virtual_network.vnet.name
  address_prefixes     = ["10.0.1.0/24"]

  depends_on = [azurerm_virtual_network.vnet]
}
# Network Security Group
resource "azurerm_network_security_group" "nsg" {
  name                = "TFSOIIINSG"
  location            = azurerm_resource_group.rg.location
  resource_group_name = azurerm_resource_group.rg.name

  security_rule {
    name                       = "SSH"
    priority                   = 1001
    direction                  = "Inbound"
    access                     = "Allow"
    protocol                   = "Tcp"
    source_port_range          = "*"
    destination_port_range     = "22"
    source_address_prefix      = "*"
    destination_address_prefix = "*"
  }
}

# Asociar NSG a la Subnet
resource "azurerm_subnet_network_security_group_association" "subnet_assoc" {
  subnet_id                 = azurerm_subnet.subnet.id
  network_security_group_id = azurerm_network_security_group.nsg.id
}

# IP pública (Standard + Static)
resource "azurerm_public_ip" "pip" {
  name                = "TFSOIIIPublicIP"
  location            = azurerm_resource_group.rg.location
  resource_group_name = azurerm_resource_group.rg.name
  allocation_method   = "Static"
  sku                 = "Standard"
}

# NIC con IP pública
resource "azurerm_network_interface" "nic" {
  name                = "TFSOIIINIC"
  location            = azurerm_resource_group.rg.location
  resource_group_name = azurerm_resource_group.rg.name

  ip_configuration {
    name                          = "internal"
    subnet_id                     = azurerm_subnet.subnet.id
    private_ip_address_allocation = "Dynamic"
    public_ip_address_id          = azurerm_public_ip.pip.id
  }
}

# Máquina virtual Linux
resource "azurerm_linux_virtual_machine" "vm" {
  name                = "OS3VM"
  resource_group_name = azurerm_resource_group.rg.name
  location            = azurerm_resource_group.rg.location
  size                = "Standard_B2as_v2"
  admin_username      = "alangarcia"

  network_interface_ids = [
    azurerm_network_interface.nic.id,
  ]

  os_disk {
    caching              = "ReadWrite"
    storage_account_type = "Standard_LRS"
  }

  source_image_reference {
    publisher = "Canonical"
    offer     = "0001-com-ubuntu-server-jammy"
    sku       = "22_04-lts-gen2"
    version   = "latest"
  }

  admin_ssh_key {
    username   = "alangarcia"
    public_key = file("~/.ssh/azure_vm_key.pub")
  }
}

# Output para mostrar la IP pública
output "vm_public_ip" {
  description = "Dirección IP pública de la máquina virtual"
  value       = azurerm_public_ip.pip.ip_address
}

Ejecutamos los comandos de terraform para iniciar el despliegue

terraform init

Luego ejecutamos

terraform plan

Y luego al confirmar todo

Terraform apply (seteamos yes)


Si da error por la VNet, ejecutar este comando

terraform import azurerm_subnet.subnet "/subscriptions/9145c68b-76f8-4b62-9061-174a25eea61f/resourceGroups/TFSOIII/providers/Microsoft.Network/virtualNetworks/TFSOIIIVnet/subnets/TFSOIIIVnet"

ssh -i ~/.ssh/azure_vm_key alangarcia@(IP VM)



#########################


####### Instalacion de Ansible #######

#Windows Ansible Client#

net user ansible asdf4321 /add
net localgroup Administrators ansible /add
Get-NetConnectionProfile
Set-NetConnectionProfile -InterfaceAlias "Ethernet0" -NetworkCategory Private
Enable-PSRemoting -Force
winrm set winrm/config/service/auth '@{Basic="true"}'
winrm set winrm/config/service '@{AllowUnencrypted="true"}'
netsh advfirewall firewall add rule name="WinRM HTTP" dir=in action=allow protocol=TCP localport=5985
winrm quickconfig

#Linux Ansible Client#

sudo adduser ansible
sudo usermod -aG sudo ansible

#Linux Ansible Server#

ssh-keygen -t rsa -b 4096

ssh-copy-id ansible@(ip_Linux_Ansible_client)

sudo apt update
sudo apt install ansible -y

sudo mkdir /etc/ansible
sudo nano /etc/ansible/hosts

[linux]
mi-vm-linux ansible_host=<IP_VM_LINUX> ansible_user=ansible ansible_ssh_private_key_file=/home/ansible/.ssh/id_rsa

[win]
mi-pc-windows ansible_host=<IP_VM_WINDOWS> ansible_user=ansible ansible_password=asdf4321 ansible_connection=winrm ansible_port=5985 ansible_winrm_scheme=http ansible_winrm_transport=basic

#Pings#

ansible linux -m ping

ansible win -m ping

########################

####### Comandos Ad-hoc #######

#Copiar archivos win#

Creamos archivo

echo "Alan Garcia - 2025-1403" > /home/alan/archivo.txt

Mover archivo de Ansible Server a Windows

ansible win -m win_copy "src=/home/alan/archivo.txt dest=C:/Users/ansible/Desktop"

Copiar archivo de escritorio a Documentos

ansible win -m win_copy "src='C:/Users/ansible/Desktop/archivo.txt' dest=src='C:/Users/ansible/Documents' remote_src=true"

#Reiniciar maquina linux#

ansible linux -m reboot -b --ask-become-pass



###############################

####### Playbooks #######

MAQUINA SERVIDOR 

# Descargar Notepad++
wget https://github.com/notepad-plus-plus/notepad-plus-plus/releases/latest/download/npp.8.8.8.portable.x64.zip -O ~/Desktop/npp_portable.zip

nano instalacion_notepad.yml 

---
- name: Instalar Notepad++ portable Windows
  hosts: win
  gather_facts: no
  tasks:
    - name: Crear carpeta en Windows
      win_file:
        path: C:\Program Files\Notepad++
        state: directory

    - name: Copiar archivo ZIP de Notepad++ a Windows
      win_copy:
        src: /home/alan/Desktop/npp_portable.zip 
        dest: C:\Program Files\Notepad++\npp_portable.zip

    - name: Descomprimir Notepad++ en Windows
      win_unzip:
        src: C:\Program Files\Notepad++\npp_portable.zip
        dest: C:\Program Files\Notepad++
        removes: C:\Program Files\Notepad++\npp_portable.zip

    - name: Verificar que Notepad++ fue instalado
      win_stat:
        path: C:\Program Files\Notepad++\notepad++.exe
      register: npp_check

    - name: Mostrar resultado de la verificación
      debug:
        msg: "Notepad++ instalado correctamente"
      when: npp_check.stat.exists

-----------------------------------------------------------------------------------------------

# Ejecucion del Playbook
ansible-playbook ~/Desktop/instalacion_notepad.yml



Playbook para instalar NGINX en la VM Linux

nano installnginx.yml

---
- name: Instalar NGINX en Linux
  hosts: linux
  become: yes
  remote_user: ansible
  tasks:
    - name: Actualizar cache de paquetes
      ansible.builtin.apt:
        update_cache: yes

    - name: Instalar NGINX
      ansible.builtin.apt:
        name: nginx
        state: present

    - name: Iniciar y habilitar NGINX
      ansible.builtin.service:
        name: nginx
        state: started
        enabled: yes

    - name: Verificar que NGINX esta funcionando
      ansible.builtin.service_facts:

    - name: Mostrar estado de NGINX
      debug:
        msg: "NGINX funcionando correctamente."
      when: "'nginx.service' in ansible_facts.services and ansible_facts.services['nginx.service'].state == 'running'"

---

Ejecucion del Playbook

ansible-playbook ~/Desktop/instalacion_nginx.yml --ask-become-pass

########################










